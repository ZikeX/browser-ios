//
//  CliqzURLBarView.swift
//  Client
//
//  Created by Sahakyan on 8/25/16.
//  Copyright Â© 2016 Mozilla. All rights reserved.
//

import UIKit
import SnapKit
import Shared
import QuartzCore

enum Whitelisted{
    case yes
    case no
    case undefined
}

class CliqzURLBarView: URLBarView {

<<<<<<< HEAD
	static let antitrackingGreenBackgroundColor = UIColor(rgb: 0x2CBA84)
    static let antitrackingOrangeBackgroundColor = UIColor(rgb: 0xF5C03E)
	static let antitrackingButtonSize = CGSizeMake(CGFloat(URLBarViewUX.ButtonWidth), CGFloat(URLBarViewUX.LocationHeight))
	private var trackersCount = 0
    
	private lazy var antitrackingButton: UIButton = {
		let button = UIButton(type: .Custom)
		button.setTitle("0", forState: .Normal)
        button.backgroundColor = UIColor.clearColor()
		button.titleLabel?.font = UIFont.systemFontOfSize(12)
=======
	fileprivate let antitrackingGreenBackgroundColor = UIColor(rgb: 0x2CBA84)
    fileprivate let antitrackingOrangeBackgroundColor = UIColor(rgb: 0xF5C03E)
	fileprivate let antitrackingButtonSize = CGSize(width: 42, height: CGFloat(URLBarViewUX.LocationHeight))
	fileprivate var trackersCount = 0
    
	fileprivate lazy var antitrackingButton: UIButton = {
		let button = UIButton(type: .custom)
		button.setTitle("0", for: UIControlState())
		button.titleLabel?.font = UIFont.systemFont(ofSize: 12)
        button.backgroundColor = self.colorForAntiTrackingButtonBackground(Whitelisted.undefined, newURL: nil)
>>>>>>> Swift3 migration
        button.accessibilityLabel = "AntiTrackingButton"
        
        let buttonImage = self.imageForAntiTrackingButton(Whitelisted.undefined)
        button.setImage(buttonImage, forState: .Normal)
        
        button.titleEdgeInsets = UIEdgeInsets(top: 5, left: 2, bottom: 5, right: 0)
        button.imageEdgeInsets = UIEdgeInsets(top: 4, left: 2, bottom: 4, right: 20)
        button.addTarget(self, action: #selector(antitrackingButtonPressed), forControlEvents: .TouchUpInside)
        button.hidden = true
        
		return button
	}()
    fileprivate lazy var newTabButton: UIButton = {
        let button = UIButton(type: .custom)
        button.setImage(UIImage.templateImageNamed("bottomNav-NewTab"), for: .normal)
        button.accessibilityLabel = NSLocalizedString("New tab", comment: "Accessibility label for the New tab button in the tab toolbar.")
        button.addTarget(self, action: #selector(CliqzURLBarView.SELdidClickNewTab), for: UIControlEvents.touchUpInside)
        return button
    }()
    
    static let antitrackingGreenIcon = UIImage(named: "antitrackingGreen")
    static let antitrackingOrangeIcon = UIImage(named: "antitrackingOrange")
    
	override init(frame: CGRect) {
		super.init(frame: frame)
		commonInit()
	}

	required init?(coder aDecoder: NSCoder) {
		super.init(coder: aDecoder)
		commonInit()
	}
    
    deinit{
        NotificationCenter.default.removeObserver(self)
    }
<<<<<<< HEAD
=======

	override func updateConstraints() {
		super.updateConstraints()
		if !antitrackingButton.isHidden {
            if self.toolbarIsShowing {
                let trailingPadding = antitrackingButtonSize.width + URLBarViewUX.URLBarButtonOffset
                locationContainer.snp_updateConstraints { make in
                    make.trailing.equalTo(shareButton.snp_leading).offset(-trailingPadding)
                }
            } else {
                let trailingPadding = antitrackingButtonSize.width + URLBarViewUX.LocationLeftPadding
                locationContainer.snp.makeConstraints { make in
                    make.trailing.equalTo(self).offset(-trailingPadding)
                }
            }
			
			self.antitrackingButton.snp_updateConstraints({ (make) in
				make.size.equalTo(self.antitrackingButtonSize)
			})
			if self.antitrackingButton.bounds.size != CGSize.zero {
                
			}
		} else {
			self.antitrackingButton.snp_updateConstraints({ (make) in
				make.size.equalTo(CGSize(width: 0, height: 0))
			})
		}
	}
>>>>>>> Swift3 migration
    
    override func prepareOverlayAnimation() {
        super.prepareOverlayAnimation()
        self.newTabButton.isHidden = !self.toolbarIsShowing
    }
    
    override func transitionToOverlay(_ didCancel: Bool = false) {
        super.transitionToOverlay(didCancel)
        self.newTabButton.alpha = inOverlayMode ? 0 : 1
    }
    override func updateViewsForOverlayModeAndToolbarChanges() {
        super.updateViewsForOverlayModeAndToolbarChanges()
        self.newTabButton.isHidden = !self.toolbarIsShowing || inOverlayMode
    }
    
	func updateTrackersCount(_ count: Int) {
        trackersCount = count
		self.antitrackingButton.setTitle("\(count)", for: UIControlState())
		self.setNeedsDisplay()
	}

<<<<<<< HEAD
	func showAntitrackingButton(hidden: Bool) {
		self.antitrackingButton.hidden = !hidden
        self.bringSubviewToFront(self.antitrackingButton)
=======
	func showAntitrackingButton(_ hidden: Bool) {
		self.antitrackingButton.isHidden = !hidden
>>>>>>> Swift3 migration
		self.setNeedsUpdateConstraints()
	}
    
    func isAntiTrackingButtonHidden() -> Bool {
        return antitrackingButton.isHidden
    }

	func enableAntitrackingButton(_ enable: Bool) {
		self.antitrackingButton.isEnabled = enable
	}
    
    func refreshAntiTrackingButton(_ notification: Notification){
        
        if let userInfo = notification.userInfo{
            
            var whitelisted : Whitelisted = .undefined
            if let onWhiteList = userInfo["whitelisted"] as? Bool{
                whitelisted = onWhiteList ? Whitelisted.yes : Whitelisted.no
            }
            
            var newURL : URL? = nil
            if let url = userInfo["newURL"] as? URL{
                newURL = url
            }
            
            let antitrackingImag = self.imageForAntiTrackingButton(whitelisted, newURL: newURL)
            self.antitrackingButton.setImage(antitrackingImag, forState: .Normal)
        }
        else {
            
            let antitrackingImag = self.imageForAntiTrackingButton(Whitelisted.undefined)
            self.antitrackingButton.setImage(antitrackingImag, forState: .Normal)
        }

    }
    
<<<<<<< HEAD
    func imageForAntiTrackingButton(whitelisted: Whitelisted, newURL: NSURL? = nil) -> UIImage? {
=======
    func colorForAntiTrackingButtonBackground(_ whitelisted: Whitelisted, newURL: URL?) -> UIColor{
>>>>>>> Swift3 migration
        
        var theURL : URL
        
        if let url = newURL {
            theURL = url
        }
<<<<<<< HEAD
        else if let url = self.currentURL {
            theURL = url
=======
        else if let url = self.currentURL{
            theURL = url as URL
>>>>>>> Swift3 migration
        }
        else {
            return CliqzURLBarView.antitrackingGreenIcon
        }
        
        guard let domain = theURL.host else {return CliqzURLBarView.antitrackingGreenIcon}
        var isAntiTrackingEnabled = false
        
        //Doc: If the observer checks if the website is whitelisted, it might get the wrong value, since the correct value may not be set yet. 
        //To avoid that whitelisted is sent as an argument, and takes precedence over isDomainWhiteListed.
        if whitelisted != .undefined{
            isAntiTrackingEnabled = whitelisted == .yes ? false : true
        }else{
            isAntiTrackingEnabled = !AntiTrackingModule.sharedInstance.isDomainWhiteListed(domain)
        }
        
        let isWebsiteOnPhisingList = AntiPhishingDetector.isDetectedPhishingURL(theURL)
        
        if isAntiTrackingEnabled && !isWebsiteOnPhisingList{
            return CliqzURLBarView.antitrackingGreenIcon
        }
        
        return CliqzURLBarView.antitrackingOrangeIcon
    }

	fileprivate func commonInit() {
        
        NotificationCenter.default.addObserver(self, selector:#selector(refreshAntiTrackingButton) , name: NSNotification.Name(rawValue: NotificationRefreshAntiTrackingButton), object: nil)
        
<<<<<<< HEAD
=======
		let img = UIImage(named: "shieldButton")
		self.antitrackingButton.setTitleColor(UIColor.white, for: UIControlState())
		self.antitrackingButton.setImage(img, for: UIControlState())
		self.antitrackingButton.titleEdgeInsets = UIEdgeInsets(top: 5, left: 2, bottom: 5, right: 0)
		self.antitrackingButton.imageEdgeInsets = UIEdgeInsets(top: 4, left: 5, bottom: 4, right: 20)
		self.antitrackingButton.addTarget(self, action: #selector(antitrackingButtonPressed), for: .touchUpInside)
		self.antitrackingButton.isHidden = true
>>>>>>> Swift3 migration
		addSubview(self.antitrackingButton)
		antitrackingButton.snp_makeConstraints { make in
			make.centerY.equalTo(self.locationContainer)
			make.leading.equalTo(self.locationContainer.snp_trailing).offset(-1 * URLBarViewUX.ButtonWidth)
			make.size.equalTo(CliqzURLBarView.antitrackingButtonSize)
		}
        
        addSubview(newTabButton)
        // Cliqz: Changed new tab position, now it should be befores tabs button
        newTabButton.snp.makeConstraints { make in
            make.right.equalTo(self.tabsButton.snp_left).offset(-URLBarViewUX.URLBarButtonOffset)
            make.centerY.equalTo(self)
            make.size.equalTo(backButton)
        }
        
        // Cliqz: Changed share position, now it should be before new tab button
		shareButton.snp.remakeConstraints { (make) in
			make.right.equalTo(self.newTabButton.snp.left).offset(-URLBarViewUX.URLBarButtonOffset)
			make.centerY.equalTo(self)
			make.size.equalTo(backButton)
		}
		
        self.actionButtons.append(newTabButton)
	}
	
<<<<<<< HEAD
	@objc private func antitrackingButtonPressed(sender: UIButton) {
        let status = CliqzURLBarView.antitrackingGreenBackgroundColor == sender.backgroundColor ? "green" : "Orange"
=======
	@objc fileprivate func antitrackingButtonPressed(_ sender: UIButton) {
        let status = antitrackingGreenBackgroundColor == sender.backgroundColor ? "green" : "Orange"
>>>>>>> Swift3 migration
		self.delegate?.urlBarDidClickAntitracking(self, trackersCount: trackersCount, status: status)
	}
    
    
    // Cliqz: Add actions for new tab button
    func SELdidClickNewTab() {
        delegate?.urlBarDidPressNewTab(self, button: newTabButton)
    }
    
    override func applyTheme(themeName: String) {
        super.applyTheme(themeName)
        
        if let theme = URLBarViewUX.Themes[themeName] {
            self.antitrackingButton.setTitleColor(theme.textColor, forState: .Normal)
        }
        
    }
}
