//
//  TabsViewController.swift
//  Client
//
//  Created by Sahakyan on 8/12/16.
//  Copyright Â© 2016 Mozilla. All rights reserved.
//

import Foundation

<<<<<<< HEAD
class Knobs{
    static let cellSpacing = 180
    static let tiltAngle = M_PI / 6.0
    static let cellHeightMultiplier = CGFloat(0.9)
    static let landscapeSize = CGSize(width: 200, height: 130)
=======
@objc protocol TabViewCellDelegate {
    func closeTab(_ tab: Tab)
>>>>>>> Swift3 migration
}

class TabsViewController: UIViewController {
	
<<<<<<< HEAD
    private let emptyTabDefaultLogoUrl = "https://cliqz.com"
    
    var collectionView: UICollectionView!
	private var addTabButton: UIButton!
=======
	fileprivate var tabsView: UITableView!
	fileprivate var addTabButton: UIButton!
>>>>>>> Swift3 migration

	let tabManager: TabManager!

	fileprivate let tabCellIdentifier = "TabCell"

	static let bottomToolbarHeight = 45
    
    var backgroundColorCache: [String:UIColor] = Dictionary()
    
    init(tabManager: TabManager) {
		self.tabManager = tabManager
		super.init(nibName: nil, bundle: nil)
		self.tabManager.addDelegate(self)
	}

	required init?(coder aDecoder: NSCoder) {
		fatalError("init(coder:) has not been implemented")
	}

	deinit {
		self.tabManager.removeDelegate(self)
	}

	override func viewDidLoad() {
		super.viewDidLoad()
<<<<<<< HEAD
        
        collectionView = UICollectionView(frame: self.view.frame, collectionViewLayout: PortraitFlowLayout())
        collectionView.registerClass(TabViewCell.self, forCellWithReuseIdentifier: "Cell")
        collectionView.backgroundColor = UIColor.clearColor()
        collectionView.showsVerticalScrollIndicator = false
        collectionView.delegate = self
        collectionView.dataSource = self
        
        self.view.addSubview(collectionView)
        
        if UIScreen.mainScreen().bounds.size.width > UIScreen.mainScreen().bounds.size.height {
            self.collectionView.collectionViewLayout = LandscapeFlowLayout()
        }
        else{
            self.collectionView.collectionViewLayout = PortraitFlowLayout()
        }
=======
		tabsView = UITableView()
		tabsView.dataSource = self
		tabsView.delegate = self
		tabsView.register(TabViewCell.self, forCellReuseIdentifier: self.tabCellIdentifier)
		tabsView.separatorStyle = .none
		tabsView.backgroundColor = UIConstants.AppBackgroundColor
		tabsView.allowsSelection = true
		view.addSubview(tabsView)
>>>>>>> Swift3 migration
		
		addTabButton = UIButton(type: .custom)
		addTabButton.setTitle("+", for: UIControlState())
		addTabButton.setTitleColor(UIColor.black, for: UIControlState())
		addTabButton.titleLabel?.font = UIFont.systemFont(ofSize: 30)
		addTabButton.titleEdgeInsets = UIEdgeInsets(top: 0, left: 0, bottom: 5, right: 0)
		addTabButton.backgroundColor =  UIColor.white
		self.view.addSubview(addTabButton)
		addTabButton.addTarget(self, action: #selector(addNewTab), for: .touchUpInside)

        let longPressGestureAddTabButton = UILongPressGestureRecognizer(target: self, action: #selector(TabsViewController.SELdidLongPressAddTab(_:)))
        addTabButton.addGestureRecognizer(longPressGestureAddTabButton)

		self.view.backgroundColor = UIConstants.AppBackgroundColor
     
	}
<<<<<<< HEAD
    
	override func viewWillAppear(animated: Bool) {
=======

	override func viewWillAppear(_ animated: Bool) {
>>>>>>> Swift3 migration
		super.viewWillAppear(animated)
		self.collectionView.reloadData()
        
	}
    
    override func viewDidAppear(animated: Bool) {
        super.viewDidAppear(animated)
        scrollToCurrentTabCell()
    }
    
	override func viewWillLayoutSubviews() {
		super.viewWillLayoutSubviews()
		self.setupConstraints()
	}
    
    override func viewDidLayoutSubviews() {
        super.viewDidLayoutSubviews()
        scrollToCurrentTabCell()
    }
    
    override func viewWillTransitionToSize(size: CGSize, withTransitionCoordinator coordinator: UIViewControllerTransitionCoordinator) {
        
        self.collectionView.alpha = 0.0
        
        coordinator.animateAlongsideTransition({ (coordinatorContext) in
            
            var layout: UICollectionViewFlowLayout
            
            if size.width > size.height{
                layout = LandscapeFlowLayout()
            }
            else{
                layout = PortraitFlowLayout()
            }
            
            self.collectionView.performBatchUpdates({
                self.collectionView.collectionViewLayout.invalidateLayout()
                self.collectionView.reloadData()
            }) { (finished) in
                self.collectionView.setCollectionViewLayout(layout, animated: true)
                self.collectionView.collectionViewLayout.invalidateLayout()
            }
            
        }) { (coordinatorContext) in
            UIView.animateWithDuration(0.3, animations: {
                self.collectionView.alpha = 1.0
            })
        }
        
    }
    
    private func scrollToCurrentTabCell() {
        // Scroll the collectionView to the current tab
        let currentTabIndex = NSIndexPath(forRow: self.tabManager.selectedIndex, inSection: 0)
        self.collectionView.scrollToItemAtIndexPath(currentTabIndex, atScrollPosition:.CenteredVertically, animated: false)
    }

	@objc fileprivate func addNewTab(_ sender: UIButton) {
		self.openNewTab()
        
        let customData: [String : AnyObject] = ["tab_count" : self.tabManager.tabs.count as AnyObject]
        TelemetryLogger.sharedInstance.logEvent(.dashBoard("open_tabs", "click", "new_tab", customData))
	}
    
<<<<<<< HEAD
    @objc func SELdidLongPressAddTab(recognizer: UILongPressGestureRecognizer) {
        let newTabHandler = { (action: UIAlertAction) in
            TelemetryLogger.sharedInstance.logEvent(.DashBoard("open_tabs", "click", "new_tab", nil))
            self.openNewTab()
            return
        }
        
        let newForgetModeTabHandler = { (action: UIAlertAction) in
            TelemetryLogger.sharedInstance.logEvent(.DashBoard("open_tabs", "click", "new_forget_tab", nil))
            
            self.openNewTab(true)
            return
        }
        
        let cancelHandler = { (action: UIAlertAction) in
            // do no thing
            TelemetryLogger.sharedInstance.logEvent(.DashBoard("open_tabs", "click", "cancel", nil))
=======
    @objc func SELdidLongPressAddTab(_ recognizer: UILongPressGestureRecognizer) {
        if #available(iOS 9, *) {
            let newTabHandler = { (action: UIAlertAction) in
                TelemetryLogger.sharedInstance.logEvent(.dashBoard("open_tabs", "click", "new_tab", nil))
                self.openNewTab()
                return
            }
            
            let newForgetModeTabHandler = { (action: UIAlertAction) in
                TelemetryLogger.sharedInstance.logEvent(.dashBoard("open_tabs", "click", "new_forget_tab", nil))
                
                self.openNewTab(true)
                return
            }
            
            let cancelHandler = { (action: UIAlertAction) in
                // do no thing
                TelemetryLogger.sharedInstance.logEvent(.dashBoard("open_tabs", "click", "cancel", nil))
            }
            
            let actionSheetController = UIAlertController.createNewTabActionSheetController(addTabButton, newTabHandler: newTabHandler, newForgetModeTabHandler: newForgetModeTabHandler, cancelHandler: cancelHandler)
            
            self.present(actionSheetController, animated: true, completion: nil)
            
            let customData: [String : AnyObject] = ["count" : self.tabManager.tabs.count as AnyObject]
            TelemetryLogger.sharedInstance.logEvent(.dashBoard("open_tabs", "longpress", "new_tab", customData))
>>>>>>> Swift3 migration
        }
        
        let actionSheetController = UIAlertController.createNewTabActionSheetController(addTabButton, newTabHandler: newTabHandler, newForgetModeTabHandler: newForgetModeTabHandler, cancelHandler: cancelHandler)
        
        self.presentViewController(actionSheetController, animated: true, completion: nil)
        
        let customData: [String : AnyObject] = ["count" : self.tabManager.tabs.count]
        TelemetryLogger.sharedInstance.logEvent(.DashBoard("open_tabs", "longpress", "new_tab", customData))
    }

	fileprivate func openNewTab(_ isPrivate: Bool = false) {
		if isPrivate {
            self.tabManager.addTabAndSelect(nil, configuration: nil, isPrivate: true)
		} else {
			self.tabManager.addTabAndSelect()
		}
		self.navigationController?.popViewController(animated: false)
	}

<<<<<<< HEAD
	private func setupConstraints() {
        
        collectionView.snp_makeConstraints { (make) in
            make.top.left.right.equalTo(self.view)
            make.bottom.equalTo(addTabButton.snp_top)
        }
=======
	fileprivate func setupConstraints() {
		tabsView.snp_makeConstraints { make in
			make.left.right.equalTo(self.view)
			make.top.equalTo(self.view).offset(10)
			make.bottom.equalTo(addTabButton.snp_top)
		}
>>>>>>> Swift3 migration
		addTabButton.snp_makeConstraints { make in
			make.centerX.equalTo(self.view)
			make.bottom.equalTo(self.view)
			make.left.right.equalTo(self.view)
			make.height.equalTo(TabsViewController.bottomToolbarHeight)
		}
	}
}

<<<<<<< HEAD
extension TabsViewController: UICollectionViewDataSource {
    
    func collectionView(collectionView: UICollectionView, numberOfItemsInSection section: Int) -> Int {
        return self.tabManager.tabs.count
    }
    
    func collectionView(collectionView: UICollectionView, cellForItemAtIndexPath indexPath: NSIndexPath) -> UICollectionViewCell {
        let cell = collectionView.dequeueReusableCellWithReuseIdentifier("Cell", forIndexPath: indexPath) as! TabViewCell
        
        cell.tag = indexPath.row
        
        let tab = self.tabManager.tabs[indexPath.row]
=======
extension TabsViewController: UITableViewDataSource, UITableViewDelegate {

	func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
		return self.tabManager.tabs.count
	}
	
	func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
		let cell = self.tabsView.dequeueReusableCell(withIdentifier: tabCellIdentifier, for: indexPath) as! TabViewCell
		let tab = self.tabManager.self.tabs[indexPath.row]
>>>>>>> Swift3 migration
        cell.delegate = self
        
        let freshtab = tab.displayURL?.absoluteString.contains("cliqz/goto.html") ?? false
        
<<<<<<< HEAD
        if tab.displayURL != nil && !freshtab{
            cell.descriptionLabel.text = tab.displayTitle
            cell.domainLabel.text = tab.displayURL?.absoluteString
        } else {
            cell.domainLabel.text = NSLocalizedString("New Tab", tableName: "Cliqz", comment: "New tab title")
            cell.descriptionLabel.text = NSLocalizedString("Topsites", tableName: "Cliqz", comment: "Title on the tab view, when no URL is open on the tab")
        }
=======
		if tab.displayURL != nil && !freshtab{
            cell.titleLabel.text = tab.title != nil && tab.title != "" ? tab.title : tab.displayURL?.absoluteString
			cell.URLLabel.text = tab.displayURL?.absoluteString
		} else {
			cell.URLLabel.text = NSLocalizedString("New Tab", tableName: "Cliqz", comment: "New tab title")
			cell.titleLabel.text = NSLocalizedString("Topsites", tableName: "Cliqz", comment: "Title on the tab view, when no URL is open on the tab")
		}
		cell.selectionStyle = .none
		cell.isPrivateTabCell = tab.isPrivate
		cell.animator.delegate = self
>>>>>>> Swift3 migration
        
        cell.domainLabel.accessibilityLabel = cell.domainLabel.text

        if tab.isPrivate{
            cell.makeCellPrivate()
        }
        else{
            cell.makeCellUnprivate()
        }
        
        let url = tab.displayURL?.absoluteString ?? emptyTabDefaultLogoUrl
        
<<<<<<< HEAD
        LogoLoader.loadLogo(url, completionBlock: { (image, error) in
            guard cell.tag == indexPath.row else { return }
            if image != nil{
                cell.setSmallUpperLogo(image)
                cell.setBigLogo(image)
            }
            else {
                let fakeLogo = LogoLoader.generateFakeLogo(url)
                cell.setBigLogoView(fakeLogo)
                let secondFakeLogo = LogoLoader.generateFakeLogo(url)
                cell.setSmallUpperLogoView(secondFakeLogo)
            }
        })
=======
        cell.tag = indexPath.row
        if let url = tab.displayURL?.absoluteString {
            LogoLoader.loadLogo(url, completionBlock: { (image, error) in
                if let img = image{
                    if cell.tag == indexPath.row{
                        cell.logoImageView.image = img
                    }
                }
            })
        }
>>>>>>> Swift3 migration
        
        
        cell.accessibilityLabel = tab.displayURL?.absoluteString
        return cell
<<<<<<< HEAD

    }
}


extension TabsViewController: UICollectionViewDelegate {
    
    func collectionView(collectionView: UICollectionView, didSelectItemAtIndexPath indexPath: NSIndexPath) {
        let tab = self.tabManager.tabs[indexPath.row]
        self.tabManager.selectTab(tab)
        self.navigationController?.popViewControllerAnimated(false)
        
        if let currentCell = collectionView.cellForItemAtIndexPath(indexPath) as? TabViewCell {
            logTabClickSignal(currentCell, indexPath: indexPath, count: self.tabManager.tabs.count, isForget: tab.isPrivate)
        }
    }
    
    func logTabClickSignal(currentCell : TabViewCell, indexPath: NSIndexPath, count: Int, isForget: Bool) {
        var customData: [String : AnyObject] = ["index" : indexPath.row, "count" : count , "is_forget" : isForget]
=======
	}
	
	func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -> CGFloat {
		return 80
	}
	
	func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
		let tab = self.tabManager.tabs[indexPath.row] //tabsToDisplay[index]
		self.tabManager.selectTab(tab)
		self.navigationController?.popViewController(animated: false)
        
        if let currentCell = tableView.cellForRow(at: indexPath) as? TabViewCell {
            logTabClickSignal(currentCell, indexPath: indexPath, count: self.tabManager.tabs.count, isForget: tab.isPrivate)
        }
        

	}
    func logTabClickSignal(_ currentCell : TabViewCell, indexPath: IndexPath, count: Int, isForget: Bool) {
        var customData: [String : AnyObject] = ["index" : indexPath.row as AnyObject, "count" : count as AnyObject , "is_forget" : isForget as AnyObject]
>>>>>>> Swift3 migration
        
        if let clickedElement = currentCell.clickedElement {
            customData["element"] = clickedElement as AnyObject?
        }
        
        TelemetryLogger.sharedInstance.logEvent(.dashBoard("open_tabs", "click", "tab", customData))
    }

}

<<<<<<< HEAD
extension TabsViewController: UICollectionViewDelegateFlowLayout {
    
    func collectionView(collectionView: UICollectionView, layout collectionViewLayout: UICollectionViewLayout, sizeForItemAtIndexPath indexPath: NSIndexPath) -> CGSize {
        var cellSize = UIScreen.mainScreen().bounds.size
=======
extension TabsViewController: SwipeAnimatorDelegate {
	func swipeAnimator(_ animator: SwipeAnimator, viewWillExitContainerBounds: UIView) {
		let tabCell = animator.container as! TabViewCell
		if let indexPath = self.tabsView.indexPath(for: tabCell) {
			let tab = self.tabManager.tabs[indexPath.row]
			tabManager.removeTab(tab)
            
            logSwipeSignal(tab, indexPath: indexPath, viewWillExitContainerBounds: viewWillExitContainerBounds)
            
		}
	}
    func logSwipeSignal(_ tab: Tab, indexPath: IndexPath, viewWillExitContainerBounds: UIView) {
>>>>>>> Swift3 migration
        
        if UIDevice.currentDevice().userInterfaceIdiom == .Phone {
            cellSize.width /= 1.22
        }
        else{
            cellSize.width /= 1.6
        }
        
<<<<<<< HEAD
        if ((collectionViewLayout as? LandscapeFlowLayout) != nil) {
            return Knobs.landscapeSize
        }
        
        if indexPath.item == collectionView.numberOfItemsInSection(0) - 1 {
            return CGSize(width: cellSize.width, height: cellSize.width * CGFloat(Knobs.cellHeightMultiplier))
        }
        
        return CGSize(width: cellSize.width, height: CGFloat(Knobs.cellSpacing))
    }
}

extension TabsViewController: TabViewCellDelegate {
    func removeTab(cell: TabViewCell, swipe: SwipeType) {
        
        guard let indexPath = self.collectionView.indexPathForCell(cell) else {return}
        
        let tab = self.tabManager.tabs[indexPath.row]
        
        var customData: [String : AnyObject] = ["count" : self.tabManager.tabs.count, "is_forget" : tab.isPrivate, "element" : "close"]
=======
        let customData: [String : AnyObject] = ["index" : indexPath.row as AnyObject, "count" : self.tabManager.tabs.count as AnyObject, "is_forget" : tab.isPrivate as AnyObject]
        TelemetryLogger.sharedInstance.logEvent(.dashBoard("open_tabs", action, "tab", customData))
    }
}

extension TabsViewController: TabManagerDelegate {
	func tabManager(_ tabManager: TabManager, didSelectedTabChange selected: Tab?, previous: Tab?) {
	}
	
	func tabManager(_ tabManager: TabManager, didCreateTab tab: Tab) {
	}
	
	func tabManager(_ tabManager: TabManager, didAddTab tab: Tab) {
        guard let index = tabManager.tabs.index(of: tab) else { return }
        self.tabsView.insertRows(at: [IndexPath(row: index, section: 0)], with: .none)
	}
    
	func tabManager(_ tabManager: TabManager, didRemoveTab tab: Tab, removeIndex: Int) {
        self.tabsView.deleteRows(at: [IndexPath(row: removeIndex, section: 0)], with: .left)
	}

	func tabManagerDidAddTabs(_ tabManager: TabManager) {
	}

	func tabManagerDidRestoreTabs(_ tabManager: TabManager) {
	}

	func tabManagerDidRemoveAllTabs(_ tabManager: TabManager, toast:ButtonToast?) {
	}
}

extension TabsViewController: TabViewCellDelegate {
    func closeTab(_ tab: Tab) {
        var customData: [String : Any] = ["count" : self.tabManager.tabs.count, "is_forget" : tab.isPrivate, "element" : "close"]
>>>>>>> Swift3 migration
        if let tabIndex = self.tabManager.getIndex(tab) {
            customData["index"] = tabIndex
        }
        
        var action = ""
        
<<<<<<< HEAD
        if swipe == .None {
            action = "click"
        }
        else if swipe == .Right {
            action = "swipe_right"
        }
        else if swipe == .Left {
            action = "swipe_left"
        }
        if self.tabManager.tabs.count == 1 {
            self.tabManager.removeTab(tab)
            self.navigationController?.popViewControllerAnimated(false)
        } else {
            self.tabManager.removeTab(tab)
        }
        
        TelemetryLogger.sharedInstance.logEvent(.DashBoard("open_tabs", action, "tab", customData))
    }
}

extension TabsViewController: TabManagerDelegate {
    func tabManager(tabManager: TabManager, didSelectedTabChange selected: Tab?, previous: Tab?) {
    }
    
    func tabManager(tabManager: TabManager, didCreateTab tab: Tab) {
    }
    
    func tabManager(tabManager: TabManager, didAddTab tab: Tab) {
        guard let index = tabManager.tabs.indexOf(tab) else { return }
        self.collectionView.insertItemsAtIndexPaths([NSIndexPath(forRow: index, inSection: 0)])//insertRowsAtIndexPaths([NSIndexPath(forRow: index, inSection: 0)], withRowAnimation: .None)
    }
    
    func tabManager(tabManager: TabManager, didRemoveTab tab: Tab, removeIndex: Int) {
        self.collectionView.deleteItemsAtIndexPaths([NSIndexPath(forRow: removeIndex, inSection: 0)])//deleteRowsAtIndexPaths([NSIndexPath(forRow: removeIndex, inSection: 0)], withRowAnimation: .Left)
    }
    
    func tabManagerDidAddTabs(tabManager: TabManager) {
    }
    
    func tabManagerDidRestoreTabs(tabManager: TabManager) {
    }
    
    func tabManagerDidRemoveAllTabs(tabManager: TabManager, toast:ButtonToast?) {
=======
        TelemetryLogger.sharedInstance.logEvent(.dashBoard("open_tabs", "click", "tab", customData))
>>>>>>> Swift3 migration
    }
}
